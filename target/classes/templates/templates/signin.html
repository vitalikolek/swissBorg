<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title th:text="'Sign In | ' + ${site_domain}"></title>
    <link rel="icon" th:href="${site_icon}">
    <link rel="stylesheet" href="assets/css/root.min.css">
    <link rel="stylesheet" href="assets/css/toastr.css">
</head>
<body class="sing-in__body">
<header th:replace="~{fragments/login-header.html :: header}"></header>
<section class="sing-in">
    <div class="sing-in__box">
        <div class="sing-in__left">
            <div class="sing-in__content">
                <div class="sing-in__title">
                    <svg width="48" height="46" viewbox="0 0 48 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M16.6685 22.4142C16.2399 22.6102 15.8116 22.8107 15.461 22.9992C9.18912 26.3304 3.38457 31.5487 0.112286 37.6668C-0.00458097 37.8897 0.0733304 38.164 0.307065 38.2787C0.540799 38.3933 0.813717 38.3052 0.930584 38.0819C4.16391 32.1195 9.81248 27.0404 15.9285 23.7936C16.1233 23.6861 16.3571 23.5745 16.5909 23.4614C16.6298 24.0158 16.8245 24.4723 17.0972 24.8404C17.5257 25.3862 18.1879 25.7569 18.967 25.9626C20.0578 26.2467 21.3431 26.2154 22.5118 25.9556C23.4078 25.7472 24.2259 25.3911 24.7324 24.9517C25.1609 24.5974 25.3945 24.1838 25.4335 23.7477C25.4725 23.2885 25.2779 22.7786 24.6936 22.2664C23.7197 21.3775 22.3949 21.1135 20.9536 21.2263C19.9018 21.3099 18.8112 21.6018 17.7983 21.9647C17.9152 21.6616 18.0711 21.3342 18.2659 20.981C19.8241 18.3278 23.5636 15.828 27.9656 13.756C34.666 10.6096 42.9247 8.47721 47.5215 8.45593C47.7552 8.45481 47.989 8.25022 47.989 7.99935C47.989 7.74847 47.7552 7.54576 47.5215 7.54688C42.8078 7.56853 34.3935 9.72785 27.5373 12.9399C22.9405 15.1071 19.0448 17.7648 17.4476 20.5405C17.058 21.2386 16.7853 21.8613 16.6685 22.4142ZM17.5256 23.0462C17.4866 23.5573 17.6034 23.9691 17.8371 24.2946C18.1488 24.6885 18.6552 24.9379 19.2006 25.0861C20.1355 25.3325 21.2654 25.2963 22.2782 25.0708C22.9794 24.9091 23.6415 24.6515 24.07 24.3167C24.3038 24.1274 24.4598 23.9217 24.4988 23.6842C24.4988 23.442 24.3427 23.1956 24.07 22.9253C23.252 22.213 22.1613 22.042 21.0316 22.1323C19.8629 22.2264 18.5774 22.6079 17.5256 23.0462Z" fill="black"></path>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M0.919934 38.0386C1.89383 35.5862 2.08883 32.7086 1.73823 30.114C1.69928 29.865 1.46562 29.6881 1.23188 29.7194C0.959194 29.7504 0.764187 29.9778 0.803143 30.2264C1.11479 32.678 0.958966 35.3977 0.0240289 37.7149C-0.0538826 37.9494 0.0630606 38.2122 0.296795 38.3018C0.569485 38.391 0.842023 38.2731 0.919934 38.0386Z" fill="black"></path>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M0.906364 38.1686C2.58146 36.2317 5.42545 35.4399 7.95757 35.136C8.19131 35.1047 8.38609 34.8769 8.34713 34.6279C8.30818 34.3793 8.07429 34.2027 7.8016 34.2341C5.0747 34.5656 1.99735 35.4795 0.166433 37.5921C0.0106106 37.7863 0.0496424 38.0726 0.244421 38.2316C0.4392 38.3911 0.750541 38.3623 0.906364 38.1686Z" fill="black"></path>
                    </svg>
                    <div style="all: unset" th:text="#{signin}">Sign in</div>
                </div>
                <div class="sing-in__des" th:text="#{signin.welcome}">Welcome back! Please enter your details</div>
                <div th:if="${error != null && error.equals('password_recovery_not_found')}" style="margin-top: 15px; color: red; font-size: 16px;" class="sing-in__des">Error: Password recovery request not found or expired, try again.</div>
                <div th:if="${error != null && error.equals('user_not_found')}" style="margin-top: 15px; color: red; font-size: 16px;" class="sing-in__des">Error: The user with this email no longer exists.</div>

                <div class="sing-in__form">
                    <div class="sing-in__email-box">
                        <div class="sing-in__form-title" th:text="#{email}">Email</div>
                        <input id="login_email" class="input__01" type="text" th:placeholder="#{sign.enter.email}">
                    </div>
                    <div class="sing-in__email-box">
                        <div class="sing-in__form-title" th:text="#{password}">Password</div>
                        <label class="input__01-password">
                            <svg width="11" height="12" viewbox="0 0 11 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9.625 5.25H9.0625V3.5625C9.0625 1.61719 7.44531 0 5.5 0C3.53125 0 1.9375 1.61719 1.9375 3.5625V5.25H1.375C0.742188 5.25 0.25 5.76562 0.25 6.375V10.875C0.25 11.5078 0.742188 12 1.375 12H9.625C10.2344 12 10.75 11.5078 10.75 10.875V6.375C10.75 5.76562 10.2344 5.25 9.625 5.25ZM7.1875 5.25H3.8125V3.5625C3.8125 2.64844 4.5625 1.875 5.5 1.875C6.41406 1.875 7.1875 2.64844 7.1875 3.5625V5.25Z" fill="#667085"></path>
                            </svg>
                            <input class="input__01" type="password" th:placeholder="#{sign.enter.password}" id="login_password">
                        </label>
                    </div>

                    <div class="sing-in__email-box">
                        <div class="sing-in__form-title" th:text="#{sign.captcha.verification}">Captcha verification</div>
                        <img id="captcha_img" th:src="${captcha}">
                        <label class="input__01-title">
                            <input class="input__01" type="number" th:placeholder="#{sign.enter.captcha}" id="captcha">
                        </label>
                    </div>

                    <div class="sing-in__params">
                        <label class="checkbox">
                            <input type="checkbox">
                            <span class="checkbox__style"></span>
                            <div style="all: unset" th:text="#{signin.remember}">Remember me</div>
                        </label>

                        <a class="sing-in__link" href="forgot-password" th:text="#{sign.forgot.password}">Forgot password</a>
                    </div>

                    <div class="sing-in__btn-box">
                        <button id="sign_in" class="buttons__01 buttons__01-sing-loader" type="submit" th:text="#{signin}">
                            Sign in
                        </button>
                    </div>

                    <div class="sing-in__have">
                        <div style="all: unset" th:text="#{signin.account}">Don’t have an account?</div>
                        <span><a href="signup" th:text="#{signin.signup}">Sign up for free</a></span>

                    </div>
                </div>
            </div>
        </div>
        <div th:replace="~{fragments/sign-in-right.html :: sing}"></div>
    </div>
</section>

<script src="../assets/js/jquery-3.4.1.min.js"></script>
<script src="../assets/js/sing-in.min.js"></script>
<script src="../assets/js/app.min.js"></script>
<script src="../assets/js/toastr.js"></script>
<script src="../assets/js/newnoti.js"></script>
</body>
</html>
<script>
    function disabledBtn(e) {
        setTimeout(function() {
            $("#sign_in").removeClass("buttons__disabled");
            $("#sign_in").removeClass("buttons__loading");
            $(".button__loader").remove();
        }, 500);
    }

    $(document).on("keydown", function(e) {
        if (e.key === "Enter") {
            $("#sign_in").click();
        }
    });

    $("#sign_in").on("click", function(e) {
        e.preventDefault();

        var captcha = $("#captcha").val();
        if (captcha === null || captcha === '') {
            captcha = 1;
        }

        var login_password = $("#login_password").val();
        var login_email = $("#login_email").val();

        if(login_email == '') {
            noti("Please enter a valid email address", 'warning');
            disabledBtn("off");
        } else if(login_password == '') {
            noti("Please enter password", 'warning');
            disabledBtn("off");
        } else {
            disabledBtn("off");

            //todo: убрать cross domain
            $.ajax({
                url: "../api/auth/login",
                type: "POST",
                xhrFields: {
                    withCredentials: true
                },
                crossDomain: true,
                contentType: "application/json",
                data: JSON.stringify({
                    email: login_email,
                    password: login_password,
                    captcha: captcha
                }),
                success: function (response, textStatus, status) {
                    if (status.status === 200) {
                        if (status.responseText.startsWith("jwt_two_factor")) {
                            location.replace("signin-2fa?token=" + status.responseText.split('jwt_two_factor: ')[1]);
                        } else {
                            setTimeout(function () {
                                location.replace("/profile/wallet");
                            }, 500);
                        }
                    } else {
                        noti("An unexpected error has occurred, please try again", "error");
                    }
                },
                error: function (xhr) {
                    const text = xhr.responseText;
                    if (text === 'bad_captcha') {
                        noti("Error receiving captcha, try again later", "error");
                        return;
                    }

                    const json = JSON.parse(text);
                    const error = json["error"];
                    const captchaUpdate = json["captcha_update"];

                    document.getElementById("captcha_img").src = captchaUpdate;

                    if (error === "wrong_captcha") {
                        noti("Captcha is wrong", "error");
                        disabledBtn('on');
                    } else if (error === 'user_not_found') {
                        noti("Such user does not exist", "error");
                        disabledBtn("on");
                    } else if (error === 'wrong_password') {
                        noti("Enter the correct password", "error");
                        disabledBtn("on");
                    } else {
                        noti("An unexpected error has occurred, please try again", "error");
                    }
                }
            });
        }
    });
</script>